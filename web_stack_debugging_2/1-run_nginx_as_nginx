#!/usr/bin/env bash
# Configure Nginx to run as nginx user and listen on port 8080

# Stop any running nginx processes
pkill -9 nginx 2>/dev/null || true

# Update nginx.conf to run as nginx user
sed -i 's/^user .*/user nginx;/' /etc/nginx/nginx.conf

# Change all listening ports from 80 to 8080
sed -i 's/listen 80 /listen 8080 /g' /etc/nginx/sites-available/default
sed -i 's/listen 80;/listen 8080;/g' /etc/nginx/sites-available/default
sed -i 's/listen \[::\]:80 /listen \[::\]:8080 /g' /etc/nginx/sites-available/default
sed -i 's/listen \[::\]:80;/listen \[::\]:8080;/g' /etc/nginx/sites-available/default

# Make sure nginx can write to necessary directories
chown -R nginx:nginx /var/lib/nginx
chown -R nginx:nginx /var/log/nginx

# Start nginx as nginx user 
su -s /bin/bash -c '/usr/sbin/nginx' nginx
